<?php
if (!defined('ABSPATH')) {
    exit;
}

$options = get_option('vietshield_options', []);
$enabled = $options['malware_scanner_enabled'] ?? true;
$schedule = $options['malware_scan_schedule'] ?? 'weekly';
$scope = $options['malware_scan_scope'] ?? 'all';
?>
<div class="wrap vietshield-wrap" id="vietshield-malware-scanner">
    <div class="vietshield-header">
        <div class="vietshield-logo">
            <span class="dashicons dashicons-shield-alt"></span>
            <h1><?php _e('Malware Scanner', 'vietshield-waf'); ?> <span style="font-size: 13px; color: #666; font-weight: 400; margin-left: 8px;">v<?php echo VIETSHIELD_VERSION; ?></span></h1>
        </div>
        <div class="vietshield-status">
            <?php if ($enabled): ?>
                <span class="status-badge status-active">
                    <span class="dashicons dashicons-yes-alt"></span>
                    <?php _e('Scanner Enabled', 'vietshield-waf'); ?>
                </span>
            <?php else: ?>
                <span class="status-badge status-inactive">
                    <span class="dashicons dashicons-dismiss"></span>
                    <?php _e('Scanner Disabled', 'vietshield-waf'); ?>
                </span>
            <?php endif; ?>
        </div>
    </div>

    <div class="vietshield-card">
        <div class="card-header">
            <h2>
                <span class="dashicons dashicons-search"></span>
                <?php _e('Malware Scan', 'vietshield-waf'); ?>
            </h2>
            <div class="header-actions">
                <select id="malware-scan-scope">
                    <option value="all" <?php selected($scope, 'all'); ?>><?php _e('All (Themes + Plugins + Uploads)', 'vietshield-waf'); ?></option>
                    <option value="themes" <?php selected($scope, 'themes'); ?>><?php _e('Themes Only', 'vietshield-waf'); ?></option>
                    <option value="plugins" <?php selected($scope, 'plugins'); ?>><?php _e('Plugins Only', 'vietshield-waf'); ?></option>
                    <option value="uploads" <?php selected($scope, 'uploads'); ?>><?php _e('Uploads Only', 'vietshield-waf'); ?></option>
                </select>
                <button id="vietshield-run-malware-scan" class="button button-primary" <?php disabled(!$enabled); ?>>
                    <span class="dashicons dashicons-search"></span>
                    <?php _e('Run Scan', 'vietshield-waf'); ?>
                </button>
                <button id="vietshield-clear-malware-history" class="button button-secondary">
                    <span class="dashicons dashicons-trash"></span>
                    <?php _e('Clear History', 'vietshield-waf'); ?>
                </button>
            </div>
        </div>
        <div class="card-body">
            <p class="description">
                <?php _e('This scan checks themes, plugins, and uploads for malicious code patterns, backdoors, and suspicious files using signature-based and heuristic detection.', 'vietshield-waf'); ?>
            </p>
            <div class="scan-meta">
                <div><strong><?php _e('Schedule:', 'vietshield-waf'); ?></strong> <?php echo esc_html(ucfirst($schedule)); ?></div>
                <div><strong><?php _e('Last Scan:', 'vietshield-waf'); ?></strong>
                    <?php
                    if (!empty($latest_scan['finished_at'])) {
                        require_once VIETSHIELD_PLUGIN_DIR . 'includes/class-vietshield-helpers.php';
                        echo esc_html(\VietShield_Helpers::format_timestamp($latest_scan['finished_at'], 'Y-m-d H:i:s'));
                        if (!empty($latest_scan['id'])) {
                            echo ' <span class="scan-id-badge">(Scan #' . esc_html($latest_scan['id']) . ')</span>';
                        }
                    } else {
                        echo esc_html__('Never', 'vietshield-waf');
                    }
                    ?>
                </div>
                <?php if (!empty($latest_scan['scope'])): ?>
                <div><strong><?php _e('Last Scope:', 'vietshield-waf'); ?></strong> <?php echo esc_html(ucfirst($latest_scan['scope'])); ?></div>
                <?php endif; ?>
            </div>
        </div>
    </div>

    <div class="vietshield-stats-grid" id="vietshield-malware-stats">
        <div class="stat-card stat-total">
            <div class="stat-icon">
                <span class="dashicons dashicons-media-code"></span>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="malware-total-files">0</div>
                <div class="stat-label"><?php _e('Files Scanned', 'vietshield-waf'); ?></div>
            </div>
        </div>
        <div class="stat-card stat-success">
            <div class="stat-icon">
                <span class="dashicons dashicons-yes-alt"></span>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="malware-clean-files">0</div>
                <div class="stat-label"><?php _e('Clean Files', 'vietshield-waf'); ?></div>
            </div>
        </div>
        <div class="stat-card stat-blocked">
            <div class="stat-icon">
                <span class="dashicons dashicons-warning"></span>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="malware-infected-files">0</div>
                <div class="stat-label"><?php _e('Infected Files', 'vietshield-waf'); ?></div>
            </div>
        </div>
        <div class="stat-card stat-sqli">
            <div class="stat-icon">
                <span class="dashicons dashicons-visibility"></span>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="malware-suspicious-files">0</div>
                <div class="stat-label"><?php _e('Suspicious Files', 'vietshield-waf'); ?></div>
            </div>
        </div>
    </div>

    <div class="vietshield-card">
        <div class="card-header">
            <h2>
                <span class="dashicons dashicons-list-view"></span>
                <?php _e('Scan Results', 'vietshield-waf'); ?>
            </h2>
            <div class="header-actions">
                <select id="malware-severity-filter">
                    <option value=""><?php _e('All Severities', 'vietshield-waf'); ?></option>
                    <option value="critical"><?php _e('Critical', 'vietshield-waf'); ?></option>
                    <option value="high"><?php _e('High', 'vietshield-waf'); ?></option>
                    <option value="medium"><?php _e('Medium', 'vietshield-waf'); ?></option>
                    <option value="low"><?php _e('Low', 'vietshield-waf'); ?></option>
                </select>
            </div>
        </div>
        <div class="card-body">
            <table class="vietshield-table" id="malware-results-table">
                <thead>
                    <tr>
                        <th><?php _e('Severity', 'vietshield-waf'); ?></th>
                        <th><?php _e('File Path', 'vietshield-waf'); ?></th>
                        <th><?php _e('Type', 'vietshield-waf'); ?></th>
                        <th><?php _e('Findings', 'vietshield-waf'); ?></th>
                        <th><?php _e('Size', 'vietshield-waf'); ?></th>
                        <th><?php _e('Modified', 'vietshield-waf'); ?></th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="empty-row">
                        <td colspan="6"><?php _e('No scan results yet. Run a scan to detect malware.', 'vietshield-waf'); ?></td>
                    </tr>
                </tbody>
            </table>
            <div class="malware-pagination" id="malware-pagination"></div>
        </div>
    </div>
</div>

<!-- Finding Details Modal -->
<div id="malware-finding-modal" class="vietshield-modal" style="display:none;">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3><span class="dashicons dashicons-warning"></span> <?php _e('Finding Details', 'vietshield-waf'); ?></h3>
            <button class="modal-close" type="button">&times;</button>
        </div>
        <div class="modal-body" id="malware-finding-details">
            <!-- Populated by JS -->
        </div>
        <div class="modal-footer">
            <button class="button button-secondary modal-close-btn" type="button"><?php _e('Close', 'vietshield-waf'); ?></button>
        </div>
    </div>
    
    <?php include VIETSHIELD_PLUGIN_DIR . 'admin/views/partials/footer.php'; ?>
</div>
